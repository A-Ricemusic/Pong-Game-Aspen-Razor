@page "/"
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<PageTitle>Home</PageTitle>

<h3>Home</h3>

<!-- Canvas for the Pong game -->
<canvas id="pongCanvas" width="800" height="600" tabindex="1" @onkeydown="OnKeyDown"></canvas>

@code {
    private int paddleX = 100;
    private int paddleY = 500;
    private int ballX = 400;
    private int ballY = 300;

    private bool isGameRunning = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Focus the canvas so it can capture key events
            await JSRuntime.InvokeVoidAsync("setFocus", "pongCanvas");

            // Draw the initial game state
            await DrawGame();

            // Start the game loop if not already running
            if (!isGameRunning)
            {
                isGameRunning = true;
                await GameLoop(); // Start the game loop
            }
        }
    }

    private async Task DrawGame()
    {
        // Ensure JS functions are available for rendering
        await JSRuntime.InvokeVoidAsync("clearCanvas");
        await JSRuntime.InvokeVoidAsync("drawPaddle", paddleX, paddleY, 100, 20);
        await JSRuntime.InvokeVoidAsync("drawBall", ballX, ballY, 10);
    }

    private int ballSpeedX = 2;
    private int ballSpeedY = 2;

    private async Task GameLoop()
    {
        while (isGameRunning)
        {
            // Move the ball
            ballX += ballSpeedX;
            ballY += ballSpeedY;

            // Detect collisions with walls
            if (ballX <= 0 || ballX >= 800) ballSpeedX = -ballSpeedX;
            if (ballY <= 0 || ballY >= 600) ballSpeedY = -ballSpeedY;

            // Redraw the game
            await DrawGame();

            // Pause briefly before the next frame (approximately 60 FPS)
            await Task.Delay(16);
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        // Handle paddle movement
        if (e.Key == "ArrowLeft")
            paddleX -= 20;
        if (e.Key == "ArrowRight")
            paddleX += 20;

        // Redraw after moving the paddle
        await DrawGame();
    }
}
